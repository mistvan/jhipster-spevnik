"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var r=[],t=/^\s*#.*/,a=!1;return e.split("\n").forEach(function(e){if(!e.match(t)){var s=_parseLine(e);_hasDirective(s,"sot")?a=!0:_hasDirective(s,"eot")?a=!1:a&&(s=[],s.push({lyrics:e})),r.push(s)}}),{parsedLines:r,title:_getDirectiveValue(r,"title"),subTitle:_getDirectiveValue(r,"subtitle"),usedChords:_getUsedChords(r)}}function _hasDirective(e,r){var t=!0,a=!1,s=void 0;try{for(var i,n=e[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var o=i.value;if(o.directive&&o.directive.type===r)return!0}}catch(c){a=!0,s=c}finally{try{!t&&n["return"]&&n["return"]()}finally{if(a)throw s}}}function _getDirectiveValue(e,r){var t=!0,a=!1,s=void 0;try{for(var i,n=e[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var o=i.value,c=!0,l=!1,u=void 0;try{for(var v,f=o[Symbol.iterator]();!(c=(v=f.next()).done);c=!0){var d=v.value;if(d.directive&&d.directive.type===r)return d.directive.value}}catch(p){l=!0,u=p}finally{try{!c&&f["return"]&&f["return"]()}finally{if(l)throw u}}}}catch(p){a=!0,s=p}finally{try{!t&&n["return"]&&n["return"]()}finally{if(a)throw s}}}function _getUsedChords(e){var r=[],t=!0,a=!1,s=void 0;try{for(var i,n=e[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var o=i.value,c=!0,l=!1,u=void 0;try{for(var v,f=function(){var e=v.value;e.chord&&e.chord.value&&!_lodash2["default"].find(r,function(r){return r.toUpperCase()===e.chord.value.toUpperCase()})&&r.push(e.chord.value)},d=o[Symbol.iterator]();!(c=(v=d.next()).done);c=!0)f()}catch(p){l=!0,u=p}finally{try{!c&&d["return"]&&d["return"]()}finally{if(l)throw u}}}}catch(p){a=!0,s=p}finally{try{!t&&n["return"]&&n["return"]()}finally{if(a)throw s}}}function _parseLine(e){var r=[];""===e&&r.push({lyrics:"&nbsp;"});for(var t=0;t<e.length;){var a={},s=_parseDirective(e.substring(t,e.length));if(s)a.directive=s,t+=s.source.length;else{var i=_parseChord(e.substring(t,e.length));i&&(a.chord=i.value,t+=i.source.length);var n=_parseWhitespace(e.substring(t,e.length));if(n)a.lyrics=n,t+=n.length;else{var o=_parseWord(e.substring(t,e.length));o?(a.lyrics=o,t+=o.length):i||t++}}r.push(a)}return r}function _parseChord(e){var r=/^\[([a-zA-Z0-9#+\/]*)\]/,t=r.exec(e);return t?{source:t[0],value:t[1]}:void 0}function _parseDirective(e){var r=/^\{\s*([^:}]*)\s*:{0,1}\s*(.*?)\s*}/,t=r.exec(e);return t?{source:t[0],type:_getDirectiveType(t[1]),value:t[2]}:void 0}function _parseWord(e){if(!_parseChord(e)&&!_parseDirective(e)){var r=/^([\[\{]?[^\s\[\{]*)/,t=r.exec(e);return t?t[1]:void 0}}function _parseWhitespace(e){var r=/^([\s]*)/,t=r.exec(e);return t?t[1]:void 0}function _getDirectiveType(e){switch(e=e.toLowerCase()){case"t":return"title";case"st":return"subtitle";case"c":return"comment";default:return e}}function _formatDirective(e){switch(e.type){case"title":return'<span class="song-title">'+e.value+"</span>";case"subtitle":return'<span class="song-subtitle">'+e.value+"</span>";case"comment":return'<span class="song-comment">'+e.value+"</span>";case"soc":return'<div class="song-soc">';case"eoc":return"</div>";case"soh":return'<div class="song-soh">';case"eoh":return"</div>";case"sot":return'<div class="song-sot">';case"eot":return"</div>";default:return""}}function _formatChord(e,r){return r||" "==e?'<span class="song-chord">'+e+"</span>":'<span class="song-chord-nolyrics">'+e+"</span>"}function _formatLyrics(e){e||(e=" ");var r=e.match(/^\s*$/);return'<span class="song-lyrics'+(r?' song-lyrics-whitespace">':'">')+e+"</span>"}function _formatParsedLine(e){var r="";r+='<span class="song-line">';var t=_lodash2["default"].find(e,function(e){return e.chord}),a=!0,s=!1,i=void 0;try{for(var n,o=e[Symbol.iterator]();!(a=(n=o.next()).done);a=!0){var c=n.value;if(r+='<span class="song-linesegment">',c.directive)r+=_formatDirective(c.directive);else{if(t){var l=c.chord?c.chord:" ";r+=_formatChord(l,c.lyrics&&!c.lyrics.match(/^\s*$/))}r+=_formatLyrics(c.lyrics)}r+="</span>"}}catch(u){s=!0,i=u}finally{try{!a&&o["return"]&&o["return"]()}finally{if(s)throw i}}return r+="</span>"}function format(e){e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var r=parse(e);return formatParseResult(r)}function formatParseResult(e){var r="";return e.parsedLines.forEach(function(e){r+=_formatParsedLine(e)}),{html:r,parseResult:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports._parseLine=_parseLine,exports._parseChord=_parseChord,exports._parseDirective=_parseDirective,exports._parseWord=_parseWord,exports._parseWhitespace=_parseWhitespace,exports.format=format,exports.formatParseResult=formatParseResult;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash);